<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Forex Analysis</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .price-flash-up {
            animation: flash-green 0.3s ease-in-out;
        }
        .price-flash-down {
            animation: flash-red 0.3s ease-in-out;
        }
        @keyframes flash-green {
            0% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.5); }
            100% { background-color: transparent; }
        }
        @keyframes flash-red {
            0% { background-color: transparent; }
            50% { background-color: rgba(239, 68, 68, 0.5); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 sm:p-8">

    <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2">Real-Time Forex Analysis with AI</h1>
        <p class="text-lg sm:text-xl text-slate-400">Powered by Deriv's API and Gemini's AI.</p>
    </header>

    <main class="container mx-auto">
        <div id="assets-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- Asset cards will be dynamically inserted here -->
        </div>
    </main>

    <script>
        const symbols = [
            'frxEURUSD', 'frxGBPUSD', 'frxUSDJPY', 'frxAUDUSD', 'frxUSDCAD', 'frxUSDCHF', 'frxNZDUSD', 'frxEURGBP', 'frxEURJPY', 'frxGBPJPY', 'frxAUDJPY', 'frxEURCAD', 'frxGBPCAD', 'frxEURAUD', 'frxGBPAUD',
            'R_10', 'R_25', 'R_50', 'R_75', 'R_100',
            '1HZ10V', '1HZ25V', '1HZ50V', '1HZ75V', '1HZ100V',
            'BOOM1000', 'CRASH1000', 'JUMP100'
        ];

        // Store price ticks and history for each asset
        const assetData = {};

        const assetsGrid = document.getElementById('assets-grid');

        // Dynamically create a card for each asset
        symbols.forEach(symbol => {
            assetData[symbol] = {
                ticks: [],
                lastPrice: null,
                cardEl: null
            };

            const card = document.createElement('div');
            card.id = `card-${symbol}`;
            card.className = "bg-slate-800 rounded-xl shadow-lg p-6 flex flex-col justify-between transition-transform transform hover:scale-105";
            card.innerHTML = `
                <div>
                    <h2 class="text-xl sm:text-2xl font-bold text-white mb-2">${symbol}</h2>
                    <p class="text-sm text-slate-400 mb-2">Current Price:</p>
                    <p id="price-${symbol}" class="text-4xl font-extrabold text-white mb-4 transition-colors duration-200">--</p>
                </div>
                <div class="space-y-4">
                    <button id="btn-${symbol}" class="w-full py-2 rounded-lg font-bold text-slate-800 bg-slate-400 opacity-50 cursor-not-allowed transition-all duration-300" disabled>
                        Collecting more data...
                    </button>
                    <div id="analysis-${symbol}" class="bg-slate-700 rounded-lg p-3 text-sm text-slate-300">
                        <span class="font-semibold text-slate-400">AI Analysis:</span> No analysis available.
                    </div>
                </div>
            `;
            assetsGrid.appendChild(card);
            assetData[symbol].cardEl = card;
        });

        // Connect to Deriv WebSocket API
        const ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');

        ws.onopen = function() {
            console.log('WebSocket connection opened.');
            // Subscribe to all assets
            symbols.forEach(symbol => {
                ws.send(JSON.stringify({
                    "ticks": symbol,
                    "subscribe": 1
                }));
            });
        };

        ws.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.msg_type === 'tick') {
                const tick = data.tick;
                const symbol = tick.symbol;
                const price = parseFloat(tick.quote);
                const epoch = tick.epoch;

                const asset = assetData[symbol];
                if (!asset) return;

                const priceEl = document.getElementById(`price-${symbol}`);
                const btnEl = document.getElementById(`btn-${symbol}`);

                // Check for price change and flash
                if (asset.lastPrice !== null) {
                    if (price > asset.lastPrice) {
                        priceEl.classList.remove('price-flash-down');
                        priceEl.classList.add('price-flash-up');
                    } else if (price < asset.lastPrice) {
                        priceEl.classList.remove('price-flash-up');
                        priceEl.classList.add('price-flash-down');
                    }
                }
                
                // Update price display
                priceEl.innerText = price.toFixed(5);
                asset.lastPrice = price;

                // Add tick to history
                asset.ticks.push({ price, epoch });
                if (asset.ticks.length > 2800) {
                    asset.ticks.shift(); // Keep only the last 20 ticks
                }

                // Check if enough data is collected to enable the button
                if (asset.ticks.length >= 2800 && btnEl.disabled) {
                    btnEl.disabled = false;
                    btnEl.classList.remove('bg-slate-400', 'opacity-50', 'cursor-not-allowed');
                    btnEl.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
                    btnEl.innerText = 'Analyze';
                }
            }
        };

        ws.onclose = function() {
            console.log('WebSocket connection closed.');
        };

        ws.onerror = function(error) {
            console.error('WebSocket Error:', error);
        };

        // Event listener for all "Analyze" buttons
        assetsGrid.addEventListener('click', async (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.id.startsWith('btn-')) {
                const symbol = e.target.id.replace('btn-', '');
                const asset = assetData[symbol];
                const analysisEl = document.getElementById(`analysis-${symbol}`);
                const btnEl = e.target;

                btnEl.disabled = true;
                btnEl.innerText = 'Analyzing...';
                analysisEl.innerHTML = `<span class="font-semibold text-slate-400">AI Analysis:</span> Analyzing...`;

                try {
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            asset: symbol,
                            data: asset.ticks,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    analysisEl.innerHTML = `<span class="font-semibold text-slate-400">AI Analysis:</span> ${result.analysis}`;

                } catch (error) {
                    console.error('Fetch error:', error);
                    analysisEl.innerHTML = `<span class="font-semibold text-red-400">AI Analysis:</span> Failed to get analysis.`;
                } finally {
                    btnEl.disabled = false;
                    btnEl.innerText = 'Analyze';
                }
            }
        });
    </script>
</body>
</html>
    
